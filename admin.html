<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Secrets of SSEI</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="./css/style.css">

<style>
  html, body { font-family: Inter, sans-serif; }
</style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-slate-100">

<!-- NAVBAR -->
<nav class="sticky top-0 z-50 backdrop-blur bg-slate-900/80 border-b border-slate-700">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
    <div>
      <h1 class="text-xl font-bold tracking-wide">Secrets of SSEI</h1>
      <p class="text-xs text-slate-400">Admin Moderation Panel</p>
    </div>
    <button id="logoutBtn"
      class="hidden px-5 py-2 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold">
      Logout
    </button>
  </div>
</nav>

<div class="max-w-5xl mx-auto p-4">

<!-- LOGIN -->
<section id="loginBox" class="max-w-md mx-auto bg-slate-800 rounded-2xl p-6 shadow-xl">
  <h2 class="text-lg font-semibold mb-4">Admin Login</h2>
  <form id="loginForm" class="space-y-4">
    <input id="email" type="email" placeholder="Email" required
      class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600">
    <input id="password" type="password" placeholder="Password" required
      class="w-full p-3 rounded-xl bg-slate-700 border border-slate-600">
    <button class="w-full py-3 rounded-xl bg-pink-600 hover:bg-pink-500 font-bold">
      Login
    </button>
    <p id="loginError" class="hidden text-red-400 text-sm"></p>
  </form>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="hidden space-y-6">

  <!-- FILTER BAR -->
  <div class="flex flex-col sm:flex-row gap-3">
    <select id="statusFilter"
      class="flex-1 p-3 rounded-xl bg-slate-800 border border-slate-600">
      <option value="all">All</option>
      <option value="pending" selected>Pending</option>
      <option value="approved">Approved</option>
      <option value="rejected">Rejected</option>
    </select>
    <button id="refreshBtn"
      class="px-6 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 font-semibold">
      Refresh
    </button>
  </div>

  <!-- LIST -->
  <div id="list" class="space-y-6"></div>
  <p id="empty" class="hidden text-center text-slate-400">No confessions</p>

</section>
</div>

<!-- ================= FIREBASE + LOGIC ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getFirestore, collection, query, orderBy, limit,
  getDocs, updateDoc, deleteDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword,
  onAuthStateChanged, signOut,
  setPersistence, browserLocalPersistence
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyD6UwsVL3aT5PME-gLa1B9v_8GrlRtluIE",
  authDomain: "login-rolebased.firebaseapp.com",
  projectId: "login-rolebased",
  storageBucket: "login-rolebased.firebasestorage.app",
  messagingSenderId: "689470574394",
  appId: "1:689470574394:web:1b51f731ce4ba7f16dca03"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
await setPersistence(auth, browserLocalPersistence);

/* DOM */
const loginBox = document.getElementById("loginBox");
const dashboard = document.getElementById("dashboard");
const logoutBtn = document.getElementById("logoutBtn");
const list = document.getElementById("list");
const empty = document.getElementById("empty");
const statusFilter = document.getElementById("statusFilter");
const refreshBtn = document.getElementById("refreshBtn");
const loginError = document.getElementById("loginError");

/* AUTH */
onAuthStateChanged(auth, user => {
  if (user && !user.isAnonymous) {
    loginBox.classList.add("hidden");
    dashboard.classList.remove("hidden");
    logoutBtn.classList.remove("hidden");
    loadData();
  } else {
    dashboard.classList.add("hidden");
    loginBox.classList.remove("hidden");
    logoutBtn.classList.add("hidden");
  }
});

loginForm.onsubmit = async e => {
  e.preventDefault();
  loginError.classList.add("hidden");
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
  } catch (err) {
    loginError.textContent = err.message;
    loginError.classList.remove("hidden");
  }
};

logoutBtn.onclick = () => signOut(auth);

/* LOAD DATA */
async function loadData() {
  list.innerHTML = "";
  empty.classList.add("hidden");

  const q = query(collection(db, "confessions"), orderBy("createdAt", "desc"), limit(50));
  const snap = await getDocs(q);

  const docs = snap.docs
    .map(d => ({ id: d.id, ...d.data() }))
    .filter(d => statusFilter.value === "all" || d.status === statusFilter.value);

  if (!docs.length) {
    empty.classList.remove("hidden");
    return;
  }

  docs.forEach(renderCard);
}

/* RENDER CARD */
function renderCard(d) {
  const card = document.createElement("div");
  card.className = "bg-slate-800 rounded-2xl border border-slate-700 p-6 shadow-xl space-y-4";

  const badge =
    d.status === "approved" ? "bg-emerald-500/20 text-emerald-300" :
    d.status === "rejected" ? "bg-red-500/20 text-red-300" :
    "bg-yellow-500/20 text-yellow-300";

  card.innerHTML = `
    <div class="flex justify-between items-center">
      <span class="px-3 py-1 rounded-full text-xs font-semibold ${badge}">
        ${d.status || "pending"}
      </span>
      <span class="text-xs text-slate-400">
        ${d.createdAt?.seconds ? new Date(d.createdAt.seconds * 1000).toLocaleString() : ""}
      </span>
    </div>

    <div class="bg-slate-900 rounded-xl p-4 text-sm leading-relaxed">
      ${escapeHtml(d.secret || "")}
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
      ${meta("From", d.from)}
      ${meta("To", d.to)}
      ${meta("Hint", d.hint)}
    </div>

    <div class="flex flex-wrap gap-3 pt-2">
      <button class="btn bg-emerald-600" data-a="approve">Approve</button>
      <button class="btn bg-amber-600" data-a="reject">Reject</button>
      <button class="btn bg-red-600" data-a="delete">Delete</button>
      <button class="btn bg-slate-700" data-a="copy">Copy Post</button>
      <button class="btn bg-indigo-600" data-a="copyall">Copy All</button>
    </div>
  `;

  card.onclick = async e => {
    const act = e.target.dataset.a;
    if (!act) return;

    if (act === "copy") {
      const text =
`${d.secret || ""}

Hint: ${d.hint || ""}

From: ${d.from || ""}
To: ${d.to || ""}`;
      await navigator.clipboard.writeText(text.trim());
      alert("Post copied");
      return;
    }

    if (act === "copyall") {
      await navigator.clipboard.writeText(JSON.stringify({
        id: d.id,
        ...d
      }, null, 2));
      alert("Full data copied");
      return;
    }

    if (act === "delete" && !confirm("Delete permanently?")) return;

    if (act === "approve" || act === "reject") {
      await updateDoc(doc(db, "confessions", d.id), {
        status: act === "approve" ? "approved" : "rejected"
      });
    }

    if (act === "delete") {
      await deleteDoc(doc(db, "confessions", d.id));
    }

    loadData();
  };

  list.appendChild(card);
}

/* HELPERS */
function meta(label, value) {
  if (!value) return "";
  return `
    <div class="bg-slate-900 rounded-xl p-3">
      <div class="text-xs text-slate-400">${label}</div>
      <div>${escapeHtml(value)}</div>
    </div>
  `;
}

function escapeHtml(s) {
  return String(s).replace(/[&<>"]/g, c =>
    ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])
  );
}

refreshBtn.onclick = loadData;
statusFilter.onchange = loadData;
</script>

<style>
  .btn {
    padding: 14px 18px;
    border-radius: 14px;
    font-weight: 700;
    font-size: 14px;
  }
</style>

</body>
</html>
