<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Secrets of SSEI — Admin</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  html, body {
    font-family: Inter, sans-serif;
  }
  .btn {
    @apply inline-flex items-center justify-center rounded-lg px-3 py-1.5 text-xs font-semibold;
  }
</style>
</head>

<body class="min-h-screen bg-slate-900 text-slate-100">
<div class="max-w-6xl mx-auto p-4 md:p-6">

<header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
  <h1 class="text-2xl font-bold">Secrets of SSEI — Admin</h1>
  <div class="flex items-center gap-3">
    <span id="whoami" class="text-xs text-slate-400"></span>
    <button id="logoutBtn" class="btn bg-slate-700 hover:bg-slate-600">Logout</button>
  </div>
</header>

<!-- LOGIN -->
<section id="loginCard" class="rounded-2xl bg-slate-800 p-6 max-w-md mx-auto border border-white/10">
  <h2 class="text-lg font-semibold mb-3">Admin Login</h2>
  <form id="loginForm" class="space-y-3">
    <input id="email" type="email" placeholder="Email" required class="w-full rounded-xl bg-slate-700 p-3 border border-slate-600">
    <input id="password" type="password" placeholder="Password" required class="w-full rounded-xl bg-slate-700 p-3 border border-slate-600">
    <button class="btn w-full bg-pink-600 hover:bg-pink-500">Login</button>
    <p id="loginError" class="text-red-400 text-sm hidden"></p>
  </form>
</section>

<!-- PANEL -->
<section id="panel" class="hidden space-y-4">

  <!-- Filters -->
  <div class="rounded-2xl bg-slate-800 p-4 border border-white/10">
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-5 gap-3">

      <select id="statusFilter" class="rounded-xl w-full bg-slate-700 p-2 border border-slate-600">
        <option value="all">All</option>
        <option value="pending" selected>Pending</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>

      <input id="searchBox" placeholder="Search" class="rounded-xl w-full bg-slate-700 p-2 border border-slate-600">

      <button id="refreshBtn" class="btn bg-slate-700 hover:bg-slate-600 w-full sm:col-span-2 md:col-span-1">Refresh</button>
    </div>
  </div>

  <div class="flex justify-between items-center">
    <h3 class="text-lg font-semibold">Submissions</h3>
    <button id="loadMoreBtn" class="btn bg-slate-700 hover:bg-slate-600">Load More</button>
  </div>

  <!-- TABLE (Desktop) -->
  <div class="hidden md:block overflow-x-auto rounded-2xl border border-white/10">
    <table class="min-w-full text-sm">
      <thead class="bg-slate-800/70">
        <tr>
          <th class="p-3 text-left">Created</th>
          <th class="p-3 text-left">Secret</th>
          <th class="p-3 text-left">From</th>
          <th class="p-3 text-left">To</th>
          <th class="p-3 text-left">Hint</th>
          <th class="p-3 text-left">Status</th>
          <th class="p-3 text-left">Actions</th>
        </tr>
      </thead>
      <tbody id="rows" class="divide-y divide-slate-800"></tbody>
    </table>
  </div>

  <!-- MOBILE CARDS -->
  <div id="mobileCards" class="md:hidden space-y-4"></div>

  <p id="emptyState" class="hidden text-center text-slate-400">No submissions.</p>

</section>
</div>

<script type="module">
/* FIREBASE IMPORTS */
const firebaseConfig = {
  apiKey: "AIzaSyD6UwsVL3aT5PME-gLa1B9v_8GrlRtluIE",
  authDomain: "login-rolebased.firebaseapp.com",
  projectId: "login-rolebased",
  storageBucket: "login-rolebased.firebasestorage.app",
  messagingSenderId: "689470574394",
  appId: "1:689470574394:web:1b51f731ce4ba7f16dca03"
};

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs, updateDoc, doc, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* ELEMENTS */
const rows = document.getElementById("rows");
const cards = document.getElementById("mobileCards");
const emptyState = document.getElementById("emptyState");
const statusFilter = document.getElementById("statusFilter");
const searchBox = document.getElementById("searchBox");

let lastDoc = null;
let currentSnapshot = [];
const PAGE_SIZE = 20;

/* LOGIN SYSTEM */
onAuthStateChanged(auth, user => {
  if (user) {
    document.getElementById("loginCard").classList.add("hidden");
    document.getElementById("panel").classList.remove("hidden");
    document.getElementById("whoami").textContent = user.email;
    resetAndLoad();
  } else {
    document.getElementById("panel").classList.add("hidden");
    document.getElementById("loginCard").classList.remove("hidden");
  }
});

document.getElementById("loginForm").onsubmit = async e => {
  e.preventDefault();
  try {
    await signInWithEmailAndPassword(
      auth,
      document.getElementById("email").value,
      document.getElementById("password").value
    );
  } catch (err) {
    loginError.textContent = err.message;
    loginError.classList.remove("hidden");
  }
};

document.getElementById("logoutBtn").onclick = () => signOut(auth);

/* FIRESTORE QUERY */
async function buildQuery(reset = false) {
  let filters = [orderBy("createdAt", "desc"), limit(PAGE_SIZE)];

  if (statusFilter.value !== "all")
    filters.unshift(where("status", "==", statusFilter.value));

  if (!reset && lastDoc) filters.push(startAfter(lastDoc));

  return query(collection(db, "confessions"), ...filters);
}

/* LOAD DATA */
async function resetAndLoad() {
  rows.innerHTML = "";
  cards.innerHTML = "";
  currentSnapshot = [];
  lastDoc = null;
  await loadMore(true);
}

async function loadMore(reset = false) {
  const q = await buildQuery(reset);
  const snap = await getDocs(q);
  const docs = snap.docs;

  if (docs.length) lastDoc = docs[docs.length - 1];

  currentSnapshot = currentSnapshot.concat(docs);
  renderData(docs);
}

/* RENDER BOTH TABLE + MOBILE CARDS */
function renderData(docs) {

  if (!docs.length && currentSnapshot.length === 0) {
    emptyState.classList.remove("hidden");
  } else emptyState.classList.add("hidden");

  const queryText = (searchBox.value || "").toLowerCase();

  docs
    .filter(d => {
      const { secret = "", hint = "", from = "", to = "" } = d.data();
      return `${secret} ${hint} ${from} ${to}`.toLowerCase().includes(queryText);
    })
    .forEach(d => {
      const data = d.data();

      /* DESKTOP ROW */
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="p-3 text-slate-400">${formatDate(data.createdAt)}</td>

        <td class="p-3">${escape(data.secret)}
          <button class="btn bg-blue-700 ml-1" data-act="copy-field" data-field="secret" data-id="${d.id}">Copy</button>
        </td>

        <td class="p-3">${escape(data.from || "")}
          <button class="btn bg-blue-700 ml-1" data-act="copy-field" data-field="from" data-id="${d.id}">Copy</button>
        </td>

        <td class="p-3">${escape(data.to || "")}
          <button class="btn bg-blue-700 ml-1" data-act="copy-field" data-field="to" data-id="${d.id}">Copy</button>
        </td>

        <td class="p-3">${escape(data.hint || "")}
          <button class="btn bg-blue-700 ml-1" data-act="copy-field" data-field="hint" data-id="${d.id}">Copy</button>
        </td>

        <td class="p-3">
          <span class="px-2 py-1 rounded text-xs ${statusColor(data.status)}">${data.status}</span>
        </td>

        <td class="p-3">
          <div class="flex gap-1">
            <button class="btn bg-emerald-600" data-act="approve" data-id="${d.id}">Approve</button>
            <button class="btn bg-amber-600" data-act="reject" data-id="${d.id}">Reject</button>
            <button class="btn bg-slate-700" data-act="copy" data-id="${d.id}">Format</button>
            <button class="btn bg-indigo-600" data-act="copyall" data-id="${d.id}">All</button>
          </div>
        </td>
      `;
      rows.appendChild(tr);

      /* MOBILE CARD */
      const card = document.createElement("div");
      card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 space-y-2";

      card.innerHTML = `
        <p class="text-xs text-slate-400">${formatDate(data.createdAt)}</p>

        <p><span class="font-semibold">Secret:</span> ${escape(data.secret)}</p>
        <button class="btn bg-blue-700" data-act="copy-field" data-field="secret" data-id="${d.id}">Copy Secret</button>

        <p><span class="font-semibold">From:</span> ${escape(data.from || "-")}</p>
        <button class="btn bg-blue-700" data-act="copy-field" data-field="from" data-id="${d.id}">Copy From</button>

        <p><span class="font-semibold">To:</span> ${escape(data.to || "-")}</p>
        <button class="btn bg-blue-700" data-act="copy-field" data-field="to" data-id="${d.id}">Copy To</button>

        <p><span class="font-semibold">Hint:</span> ${escape(data.hint || "-")}</p>
        <button class="btn bg-blue-700" data-act="copy-field" data-field="hint" data-id="${d.id}">Copy Hint</button>

        <p class="mt-2"><span class="font-semibold">Status:</span>
          <span class="px-2 py-1 rounded ${statusColor(data.status)} text-xs">${data.status}</span>
        </p>

        <div class="flex flex-wrap gap-2 mt-3">
          <button class="btn bg-emerald-600" data-act="approve" data-id="${d.id}">Approve</button>
          <button class="btn bg-amber-600" data-act="reject" data-id="${d.id}">Reject</button>
          <button class="btn bg-slate-700" data-act="copy" data-id="${d.id}">Copy Format</button>
          <button class="btn bg-indigo-600" data-act="copyall" data-id="${d.id}">Copy All</button>
        </div>
      `;
      cards.appendChild(card);
    });
}

/* HELPERS */
function formatDate(ts) {
  if (!ts) return "-";
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return d.toLocaleString();
}

function escape(str) {
  return String(str).replace(/[&<>"]/g, s => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;" }[s]));
}

function statusColor(s) {
  return s === "approved"
    ? "bg-emerald-800/60"
    : s === "rejected"
    ? "bg-amber-800/60"
    : "bg-slate-700/60";
}

/* ACTION HANDLER */
document.body.addEventListener("click", async e => {
  const btn = e.target.closest("button[data-act]");
  if (!btn) return;

  const id = btn.dataset.id;
  const act = btn.dataset.act;
  const field = btn.dataset.field;

  const docRef = currentSnapshot.find(x => x.id === id);
  if (!docRef) return;

  const data = docRef.data();

  // Copy specific field
  if (act === "copy-field") {
    await navigator.clipboard.writeText(data[field] || "");
    btn.textContent = "Copied!";
    setTimeout(() => (btn.textContent = "Copy"), 1000);
    return;
  }

  // Copy formatted
  if (act === "copy") {
    const txt = `Secret: ${data.secret}
Hint: ${data.hint}
From: ${data.from || "-"}
To: ${data.to || "-"}`;
    await navigator.clipboard.writeText(txt);
    btn.textContent = "Copied!";
    setTimeout(() => (btn.textContent = "Copy"), 1000);
    return;
  }

  // Copy all
  if (act === "copyall") {
    await navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    btn.textContent = "Copied!";
    setTimeout(() => (btn.textContent = "Copy All"), 1000);
    return;
  }

  // Approve / Reject
  const newStatus = act === "approve" ? "approved" : "rejected";
  await updateDoc(doc(db, "confessions", id), {
    status: newStatus,
    moderatedAt: serverTimestamp()
  });

  resetAndLoad();
});

/* BUTTON BINDINGS */
document.getElementById("refreshBtn").onclick = resetAndLoad;
document.getElementById("loadMoreBtn").onclick = () => loadMore(false);

searchBox.addEventListener("keydown", e => {
  if (e.key === "Enter") resetAndLoad();
});
</script>

</body>
</html>
